@model CAPS.Models.Transaction

@{
    ViewData["Title"] = Model.TransactionId == 0 ? "New Transaction" : "Edit Transaction";
    var isEdit = Model.TransactionId != 0;
}

<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h2 class="text-primary">
                <i class="fas fa-receipt me-2"></i>@ViewData["Title"]
            </h2>
            <p class="text-muted">@(isEdit ? "Update transaction details" : "Create a new transaction")</p>
        </div>
        <div class="col-md-6 text-end">
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to List
            </a>
        </div>
    </div>

    <form asp-action="UpSert" method="post" id="transactionForm">
        <input type="hidden" asp-for="TransactionId" />
        <input type="hidden" asp-for="DateCreated" />
        <input type="hidden" asp-for="IsActive" />

        <div class="row">
            <!-- Left Column - Main Transaction Details -->
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>Transaction Details
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Transaction Date -->
                            <div class="col-md-6 mb-3">
                                <label asp-for="TransactionDate" class="form-label">Transaction Date *</label>
                                <input asp-for="TransactionDate" type="datetime-local" class="form-control" required />
                                <span asp-validation-for="TransactionDate" class="text-danger"></span>
                            </div>

                            <!-- Receipt Number -->
                            <div class="col-md-6 mb-3">
                                <label asp-for="ReceiptNumber" class="form-label">Receipt Number</label>
                                <div class="input-group">
                                    <input asp-for="ReceiptNumber" class="form-control" placeholder="Auto-generated if empty" />
                                    <button type="button" class="btn btn-outline-secondary" id="generateReceipt">
                                        <i class="fas fa-magic"></i> Generate
                                    </button>
                                </div>
                                <span asp-validation-for="ReceiptNumber" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Client Selection -->
                            <div class="col-md-6 mb-3">
                                <label asp-for="ClientId" class="form-label">Client *</label>
                                <select asp-for="ClientId" class="form-select" required>
                                    <option value="">Select Client</option>
                                    @foreach (var client in ViewBag.Clients)
                                    {
                                        <option value="@client.ClientId">
                                            @client.FirstName @client.LastName - @client.PhoneNumber
                                        </option>
                                    }
                                </select>
                                <span asp-validation-for="ClientId" class="text-danger"></span>
                            </div>

                            <!-- Service Selection -->
                            <div class="col-md-6 mb-3">
                                <label asp-for="ServiceId" class="form-label">Service *</label>
                                <select asp-for="ServiceId" class="form-select" required id="serviceSelect">
                                    <option value="">Select Service</option>
                                    @foreach (var service in ViewBag.Services)
                                    {
                                        <option value="@service.ServiceId" 
                                                data-price="@service.Price" 
                                                data-duration="@service.Duration"
                                                >
                                            @service.Name - $@service.Price (@service.Duration min)
                                        </option>
                                    }
                                </select>
                                <span asp-validation-for="ServiceId" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Staff Selection -->
                            <div class="col-md-6 mb-3">
                                <label asp-for="StaffId" class="form-label">Staff Member</label>
                                <select asp-for="StaffId" class="form-select">
                                    <option value="">Select Staff (Optional)</option>
                                    @foreach (var staff in ViewBag.Staff)
                                    {
                                        <option value="@staff.StaffId">
                                            @staff.FullName
                                        </option>
                                    }
                                </select>
                                <span asp-validation-for="StaffId" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Status -->
                            <div class="col-md-6 mb-3">
                                <label asp-for="Status" class="form-label">Status *</label>
                                <select asp-for="Status" class="form-select" required>
                                    <option value="Completed">Completed</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Cancelled">Cancelled</option>
                                    <option value="Refunded">Refunded</option>
                                </select>
                                <span asp-validation-for="Status" class="text-danger"></span>
                            </div>

                            <!-- Invoice Number -->
                            <div class="col-md-6 mb-3">
                                <label asp-for="InvoiceNumber" class="form-label">Invoice Number</label>
                                <input asp-for="InvoiceNumber" class="form-control" placeholder="Optional invoice number" />
                                <span asp-validation-for="InvoiceNumber" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="mb-3">
                            <label asp-for="Notes" class="form-label">Notes</label>
                            <textarea asp-for="Notes" class="form-control" rows="3" placeholder="Additional notes about this transaction..."></textarea>
                            <span asp-validation-for="Notes" class="text-danger"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Pricing & Calculations -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-calculator me-2"></i>Pricing & Calculations
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Base Amount -->
                        <div class="mb-3">
                            <label asp-for="Amount" class="form-label">Base Amount *</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input asp-for="Amount" type="number" step="0.01" min="0" class="form-control" required id="baseAmount" />
                            </div>
                            <span asp-validation-for="Amount" class="text-danger"></span>
                        </div>

                        <!-- Discount Section -->
                        <div class="card mb-3" style="background-color: #f8f9fa;">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Discount</h6>
                                
                                <div class="mb-2">
                                    <label asp-for="DiscountPercentage" class="form-label small">Discount %</label>
                                    <div class="input-group">
                                        <input asp-for="DiscountPercentage" type="number" step="0.01" min="0" max="100" class="form-control" id="discountPercentage" />
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>

                                <div class="mb-2">
                                    <label asp-for="DiscountAmount" class="form-label small">Discount Amount</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input asp-for="DiscountAmount" type="number" step="0.01" min="0" class="form-control" id="discountAmount" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tax Section -->
                        <div class="card mb-3" style="background-color: #f8f9fa;">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Tax</h6>
                                
                                <div class="mb-2">
                                    <label asp-for="TaxPercentage" class="form-label small">Tax %</label>
                                    <div class="input-group">
                                        <input asp-for="TaxPercentage" type="number" step="0.01" min="0" max="100" class="form-control" id="taxPercentage" />
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>

                                <div class="mb-2">
                                    <label asp-for="TaxAmount" class="form-label small">Tax Amount</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input asp-for="TaxAmount" type="number" step="0.01" min="0" class="form-control" id="taxAmount" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Total Amount Display -->
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h6 class="card-title">Total Amount</h6>
                                <h3 class="mb-0" id="totalAmountDisplay">$0.00</h3>
                                <input type="hidden" asp-for="TotalAmount" id="totalAmount" />
                            </div>
                        </div>

                        <!-- Calculate Button -->
                        <div class="mt-3">
                            <button type="button" class="btn btn-outline-primary w-100" id="calculateTotal">
                                <i class="fas fa-calculator me-2"></i>Recalculate Total
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <button type="submit" class="btn btn-primary btn-lg me-3">
                            <i class="fas fa-save me-2"></i>@(isEdit ? "Update Transaction" : "Create Transaction")
                        </button>
                        <a asp-action="Index" class="btn btn-outline-secondary btn-lg">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Initialize form with current date/time if creating new transaction
            if (@Model.TransactionId == 0) {
                var now = new Date();
                var localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                $('#TransactionDate').val(localDateTime);
            }

            // Auto-fill service price when service is selected
            $('#serviceSelect').on('change', function() {
                var selectedOption = $(this).find('option:selected');
                var price = selectedOption.data('price');
                var duration = selectedOption.data('duration');
                
                if (price) {
                    $('#baseAmount').val(price);
                    calculateTotal();
                }
            });

            // Calculate total when any pricing field changes
            $('#baseAmount, #discountPercentage, #discountAmount, #taxPercentage, #taxAmount').on('input', function() {
                calculateTotal();
            });

            // Generate receipt number
            $('#generateReceipt').on('click', function() {
                var today = new Date();
                var dateStr = today.getFullYear().toString() + 
                             (today.getMonth() + 1).toString().padStart(2, '0') + 
                             today.getDate().toString().padStart(2, '0');
                
                // Generate a random 4-digit number
                var randomNum = Math.floor(Math.random() * 9000) + 1000;
                var receiptNumber = 'RCP' + dateStr + '-' + randomNum;
                
                $('#ReceiptNumber').val(receiptNumber);
            });

            // Calculate total function
            function calculateTotal() {
                var baseAmount = parseFloat($('#baseAmount').val()) || 0;
                var discountPercentage = parseFloat($('#discountPercentage').val()) || 0;
                var discountAmount = parseFloat($('#discountAmount').val()) || 0;
                var taxPercentage = parseFloat($('#taxPercentage').val()) || 0;
                var taxAmount = parseFloat($('#taxAmount').val()) || 0;

                var subtotal = baseAmount;

                // Apply discount
                if (discountPercentage > 0) {
                    discountAmount = subtotal * (discountPercentage / 100);
                    $('#discountAmount').val(discountAmount.toFixed(2));
                }
                
                if (discountAmount > 0) {
                    subtotal -= discountAmount;
                }

                // Apply tax
                if (taxPercentage > 0) {
                    taxAmount = subtotal * (taxPercentage / 100);
                    $('#taxAmount').val(taxAmount.toFixed(2));
                }
                
                if (taxAmount > 0) {
                    subtotal += taxAmount;
                }

                var total = subtotal;
                
                // Update display and hidden field
                $('#totalAmountDisplay').text('$' + total.toFixed(2));
                $('#totalAmount').val(total.toFixed(2));
            }

            // Manual calculate button
            $('#calculateTotal').on('click', function() {
                calculateTotal();
            });

            // Form validation
            $('#transactionForm').on('submit', function(e) {
                var isValid = true;
                
                // Check required fields
                if (!$('#ClientId').val()) {
                    alert('Please select a client.');
                    isValid = false;
                }
                
                if (!$('#ServiceId').val()) {
                    alert('Please select a service.');
                    isValid = false;
                }
                
                if (!$('#Amount').val() || parseFloat($('#Amount').val()) <= 0) {
                    alert('Please enter a valid base amount.');
                    isValid = false;
                }
                
                if (!isValid) {
                    e.preventDefault();
                }
            });

            // Auto-calculate on page load
            calculateTotal();
        });
    </script>
}

<style>
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
    }
    
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid rgba(0, 0, 0, 0.125);
    }
    
    .form-label {
        font-weight: 600;
        color: #495057;
    }
    
    .input-group-text {
        background-color: #e9ecef;
        border-color: #ced4da;
    }
    
    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-size: 1.1rem;
    }
    
    .text-danger {
        font-size: 0.875rem;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .bg-primary {
        background-color: #0d6efd !important;
    }
    
    .card-body {
        padding: 1.5rem;
    }
</style>
