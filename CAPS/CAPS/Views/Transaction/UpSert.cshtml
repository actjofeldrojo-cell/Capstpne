@model CAPS.Models.Transaction

@{
    ViewData["Title"] = Model.TransactionId == 0 ? "New Transaction" : "Edit Transaction";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    var isEdit = Model.TransactionId != 0;
}

<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h2 class="text-primary">
                <i class="fas fa-receipt me-2"></i>@ViewData["Title"]
            </h2>
            <p class="text-muted">@(isEdit ? "Update transaction details" : "Create a new transaction")</p>
            @if (Model.ClientId > 0 && !isEdit)
            {
                <div class="alert alert-info">
                    <i class="fas fa-user me-2"></i>
                    <strong>Client Pre-selected:</strong> This transaction is for a specific client from the Client management page.
                </div>
            }
        </div>
        <div class="col-md-6 text-end">
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to List
            </a>
        </div>
    </div>

    <form asp-action="UpSert" method="post" id="transactionForm">
        <input type="hidden" asp-for="TransactionId" />
        <input type="hidden" asp-for="DateCreated" />
        <input type="hidden" asp-for="IsActive" value="true" />
        <input type="hidden" asp-for="ClientId" />
        <input type="hidden" asp-for="StaffId" value="1" />
        <input type="hidden" asp-for="Status" value="Completed" />

        <div class="row">
            <!-- Client Information Card -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-user me-2"></i>Client Information
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (Model.ClientId > 0)
                        {
                            var client = ViewBag.Clients as List<CAPS.Models.Client>;
                            var selectedClient = client?.FirstOrDefault(c => c.ClientId == Model.ClientId);
                            if (selectedClient != null)
                            {
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Client Name</label>
                                        <p class="form-control-plaintext">@selectedClient.FirstName @selectedClient.LastName</p>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Phone Number</label>
                                        <p class="form-control-plaintext">@selectedClient.PhoneNumber</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Gender</label>
                                        <p class="form-control-plaintext">@selectedClient.Gender</p>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Registered On</label>
                                        <p class="form-control-plaintext">@selectedClient.DateRegistered.ToString("yyyy-MM-dd")</p>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>

            <!-- Service Selection -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-concierge-bell me-2"></i>Availed Services
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (ViewBag.AvailedServices != null)
                        {
                            <div class="mb-3">
                                <label class="form-label fw-bold text-success">Client's Availed Services</label>
                                <div class="availed-services-list">
                                    @foreach (CAPS.Controllers.AvailedServiceViewModel availedService in ViewBag.AvailedServices)
                                    {
                                        <div class="service-item mb-2 p-3 border rounded @(availedService.Service.ServiceId == Model.ServiceId ? "bg-success text-white" : "bg-light")">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <span class="fw-bold">@availedService.Service.Name</span>
                                                    <small class="@(availedService.Service.ServiceId == Model.ServiceId ? "text-white-50" : "text-muted") d-block">
                                                        @availedService.TotalDuration min - $@availedService.Service.Price
                                                    </small>
                                                </div>
                                                @if (availedService.Service.ServiceId == Model.ServiceId)
                                                {
                                                    <span class="badge bg-white text-success">
                                                        <i class="fas fa-check me-1"></i>Selected
                                                    </span>
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="mb-3">
                                <label asp-for="ServiceId" class="form-label">Service *</label>
                                <select asp-for="ServiceId" class="form-select" required id="serviceSelect">
                                    <option value="">Select Service</option>
                                    @foreach (var service in ViewBag.Services)
                                    {
                                        <option value="@service.ServiceId" 
                                                data-price="@service.Price" 
                                                data-duration="@service.Duration">
                                            @service.Name - $@service.Price (@service.Duration min)
                                        </option>
                                    }
                                </select>
                                <span asp-validation-for="ServiceId" class="text-danger"></span>
                            </div>
                        }
                        
                        <!-- Hidden field to ensure ServiceId is always set when availed services are shown -->
                        @if (ViewBag.AvailedServices != null)
                        {
                            <input type="hidden" asp-for="ServiceId" id="hiddenServiceId" />
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Information -->
        <div class="row">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-credit-card me-2"></i>Payment Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Amount to Pay</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input asp-for="Amount" type="number" step="0.01" min="0" class="form-control" required id="amountToPay" />
                                </div>
                                <span asp-validation-for="Amount" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Tendered Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" step="0.01" min="0" class="form-control" id="tenderedAmount" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Change</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="text" class="form-control" id="changeAmount" readonly />
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label asp-for="PaymentMethod" class="form-label fw-bold">Payment Method</label>
                                <select asp-for="PaymentMethod" class="form-select">
                                    <option value="Cash">Cash</option>
                                    <option value="Credit Card">Credit Card</option>
                                    <option value="Debit Card">Debit Card</option>
                                    <option value="Online Payment">Online Payment</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Notes" class="form-label fw-bold">Notes</label>
                                <textarea asp-for="Notes" class="form-control" rows="2" placeholder="Additional notes..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <button type="button" class="btn btn-success btn-lg me-3" id="completePayment">
                            <i class="fas fa-check-circle me-2"></i>Completed
                        </button>
                        <a asp-action="Index" class="btn btn-outline-secondary btn-lg">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Auto-fill service price when service is selected from dropdown
            $('#serviceSelect').on('change', function() {
                var selectedOption = $(this).find('option:selected');
                var price = selectedOption.data('price');
                
                if (price) {
                    $('#amountToPay').val(price);
                    calculateChange();
                }
            });

            // Calculate change when tendered amount changes
            $('#tenderedAmount').on('input', function() {
                calculateChange();
            });

            // Auto-fill amount if service is pre-selected
            @if (Model.ServiceId > 0)
            {
                <text>
                var preSelectedPrice = @Model.Amount;
                $('#amountToPay').val(preSelectedPrice);
                calculateChange();
                </text>
            }

            // Calculate change function
            function calculateChange() {
                var amountToPay = parseFloat($('#amountToPay').val()) || 0;
                var tenderedAmount = parseFloat($('#tenderedAmount').val()) || 0;
                var change = tenderedAmount - amountToPay;
                
                $('#changeAmount').val(change.toFixed(2));
                
                // Enable/disable Complete Payment button
                if (tenderedAmount >= amountToPay && tenderedAmount > 0) {
                    $('#completePayment').prop('disabled', false);
                } else {
                    $('#completePayment').prop('disabled', true);
                }
            }

            // Complete Payment button click
            $('#completePayment').on('click', function() {
                var amountToPay = parseFloat($('#amountToPay').val()) || 0;
                var tenderedAmount = parseFloat($('#tenderedAmount').val()) || 0;
                var serviceId = $('#serviceSelect').val() || $('#hiddenServiceId').val();
                var hasAvailedServices = @(ViewBag.AvailedServices != null ? "true" : "false");
                
                // Validation - only check service if no availed services are pre-selected
                if (!hasAvailedServices && !serviceId) {
                    alert('Please select a service.');
                    return;
                }
                
                if (amountToPay <= 0) {
                    alert('Please enter a valid amount to pay.');
                    return;
                }
                
                if (tenderedAmount < amountToPay) {
                    alert('Tendered amount must be greater than or equal to amount to pay.');
                    return;
                }
                
                // Show loading state
                $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Processing...');
                
                // Submit the form
                $('#transactionForm').submit();
            });

            // Initialize change calculation
            calculateChange();
        });
    </script>
}

<style>
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
    }
    
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid rgba(0, 0, 0, 0.125);
    }
    
    .form-label {
        font-weight: 600;
        color: #495057;
    }
    
    .input-group-text {
        background-color: #e9ecef;
        border-color: #ced4da;
    }
    
    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-size: 1.1rem;
    }
    
    .text-danger {
        font-size: 0.875rem;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .bg-primary {
        background-color: #0d6efd !important;
    }
    
    .card-body {
        padding: 1.5rem;
    }
</style>
